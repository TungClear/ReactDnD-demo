var entities = [
    {
        "_id": "5cebc82cfdce2725535bed22cPVD7mkb",
        "name": "number",
        "agent_id": null,
        "synonym": 2,
        "type": 2,
        "content": [
            {
                "name": "one",
                "same_value": [
                    "1",
                    "mno xyz",
                ],
            },
            {
                "name": "two",
                "same_value": [
                    "two",
                    "2",
                ],
            },
        ],
        "language_code": "en",
        "description": "numeric",
        "created_at": 1558956076,
        "updated_at": 1558956076,
        "created_by": "5ce51dc4fdce27077c6164c7zFCXadGc",
        "updated_by": "5ce51dc4fdce27077c6164c7zFCXadGc",
    },
    {
        "_id": "5ce6805b37771630f06b0dc2vqVu48J7",
        "name": "add entity system",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "drink",
                "same_value": [
                    "123",
                    "123"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558610011,
        "updated_at": 1558610011,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618e337771630ec2f0befx8wR6Lj2",
        "name": "add entity system 12",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583523,
        "updated_at": 1558583523,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618e13777163126454debEtn1ZLU8",
        "name": "add entity system 11",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583521,
        "updated_at": 1558583521,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618de37771630f06b0dc0sfgMLzgp",
        "name": "add entity system 10",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583518,
        "updated_at": 1558583518,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618db37771630ee1fd14aRJRWAJTS",
        "name": "add entity system 9",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583514,
        "updated_at": 1558583514,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618d537771630ef12ae7f0TyN8aKz",
        "name": "add entity system 8",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583509,
        "updated_at": 1558583509,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618d137771630ed5bf514COgGBpVW",
        "name": "add entity system 7",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583505,
        "updated_at": 1558583505,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618ce377716563c785ff94UoBZWrE",
        "name": "add entity system 6",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583502,
        "updated_at": 1558583502,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618cb37771630ec2f0bee78scu9lg",
        "name": "add entity system 5",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583499,
        "updated_at": 1558583499,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce618c63777163126454dea5VwJQWds",
        "name": "add entity system 4",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "coca",
                "same_value": [
                    "tea",
                    "cafe"
                ]
            },
            {
                "name": "fanta",
                "same_value": [
                    "nitifood",
                    "cafe"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558583494,
        "updated_at": 1558583494,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce61897377716563c785ff8UhnjrTGb",
        "name": "add entity system 3",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "check",
                "same_value": [
                    "check",
                    "check2"
                ]
            }
        ],
        "language_code": "en",
        "description": null,
        "created_at": 1558583447,
        "updated_at": 1558583447,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce60cf537771630ec2f0bedpLWeCjxb",
        "name": "add entity system 2",
        "agent_id": null,
        "synonym": 1,
        "type": 2,
        "content": [
            {
                "name": "cafe",
                "same_value": [
                    "cxxcv",
                    "zxczxczxc"
                ]
            }
        ],
        "language_code": "en",
        "description": "demo description",
        "created_at": 1558580469,
        "updated_at": 1558580469,
        "created_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
        "updated_by": "5ce52ee237771630f06b0dbfm8HiEF3I",
    },
    {
        "_id": "5ce51445377716563c785ff1v4u79F8i",
        "name": "topping",
        "agent_id": "5ce510b53777163126454de3AR3UBd1c",
        "synonym": 2,
        "type": 1,
        "content": [
            {
                "name": "chocolate",
                "same_value": [
                    "chocolate",
                    "chocolate syrup",
                    "chocolate drizzle"
                ]
            },
            {
                "name": "whipped cream",
                "same_value": [
                    "whipped cream",
                    "whip"
                ]
            },
            {
                "name": "cinnamon",
                "same_value": [
                    "cinnamon"
                ]
            },
            {
                "name": "caramel",
                "same_value": [
                    "caramel"
                ]
            }
        ],
        "language_code": "vi",
        "description": null,
        "user_id": "5ce4bedd37771630ee1fd135df9e3o0S",
        "created_at": 1558516805,
        "updated_at": 1558516805,
        "created_by": "5ce4bedd37771630ee1fd135df9e3o0S",
        "updated_by": "5ce4bedd37771630ee1fd135df9e3o0S",
    },
    {
        "_id": "5ce513c837771630ed5bf510pSJdEXxa",
        "name": "size",
        "agent_id": "5ce510b53777163126454de3AR3UBd1c",
        "synonym": 2,
        "type": 1,
        "content": [
            {
                "name": "large",
                "same_value": [
                    "large",
                    "huge",
                    "big"
                ]
            },
            {
                "name": "medium",
                "same_value": [
                    "medium"
                ]
            },
            {
                "name": "small",
                "same_value": [
                    "small",
                    "little",
                    "short",
                    "tall"
                ]
            }
        ],
        "language_code": "vi",
        "description": null,
        "user_id": "5ce4bedd37771630ee1fd135df9e3o0S",
        "created_at": 1558516680,
        "updated_at": 1558516680,
        "created_by": "5ce4bedd37771630ee1fd135df9e3o0S",
        "updated_by": "5ce4bedd37771630ee1fd135df9e3o0S",
    },
    {
        "_id": "5ce5121f37771630ef12ae75TzREMgl7",
        "name": "shop",
        "agent_id": "5ce510b53777163126454de3AR3UBd1c",
        "synonym": 1,
        "type": 1,
        "content": [
            {
                "name": "drink",
                "same_value": [
                    "tea",
                    "coffee",
                    "123"
                ]
            },
            {
                "name": "eat",
                "same_value": [
                    "apple",
                    "tomato"
                ]
            }
        ],
        "language_code": "vi",
        "description": null,
        "user_id": "5ce4bedd37771630ee1fd135df9e3o0S",
        "created_at": 1558516255,
        "updated_at": 1558516255,
        "created_by": "5ce4bedd37771630ee1fd135df9e3o0S",
        "updated_by": "5ce4bedd37771630ee1fd135df9e3o0S",
    }
];

var entitiesMap = {};

// index entities
for (let i = 0; i < entities.length; i++) {
    for (let k = 0; k < entities[i]['content'].length; k++) {
        if (!entitiesMap[entities[i]['content'][k]['name']]) {
            entitiesMap[entities[i]['content'][k]['name']] = {
                "_id": entities[i]['_id'],
                "name": entities[i]['name'],
                "type": entities[i]['type'],
            };
        }
        for (let j = 0; j < entities[i]['content'][k]['same_value'].length; j++) {
            if (!entitiesMap[entities[i]['content'][k]['same_value'][j]]) {
                entitiesMap[entities[i]['content'][k]['same_value'][j]] = {
                    "_id": entities[i]['_id'],
                    "name": entities[i]['name'],
                    "type": entities[i]['type'],
                };
            }
        }
    }
}

// TODO process input
var input = '  mno xyz big cup   and 2                 big pig and 1 big dog   ';

input = input.trim().replace(/\s+/g, ' ');

var entityMark = new Array(input.length);
var entityCount = 1;
var entityFound = {};

for (let key in entitiesMap) {
    let start = input.indexOf(key);
    while (start != -1 && ! (entityMark[start] || entityMark[start + key.length - 1])) {
        for (let i = start; i < start + key.length; i++) {
            entityMark[i] = entityCount;
        }
        entityFound[entityCount++] = entitiesMap[key];
        start = input.indexOf(key, start + 1);
    }
}

let result = [];

let start = 0, end = 1;
while (start < input.length) {
    if (end == input.length || entityMark[end] != entityMark[start]) {
        let preparedData = {
            "text": input.slice(start, end),
        };
        if (entityMark[start]) {
            preparedData["alias"] = entityFound[entityMark[start]]['name'];
            preparedData['entity_id'] = entityFound[entityMark[start]]['_id'];
            preparedData['user_defined'] = 2;
        }
        result.push(preparedData);
        start = end;
    }
    end++;
}

console.log(result);
